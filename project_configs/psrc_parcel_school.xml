<opus_project>
  <xml_version>2.0</xml_version>
  <general>
    <description type="string">Configuration for the PSRC parcel project with school choice model</description>
    <parent type="file">psrc_parcel_new_repm_hlcm.xml</parent>
    <expression_library type="dictionary">
      <variable use="model variable" source="expression" name="person.valid_hhchild" type="variable_definition">person.disaggregate(household.children>0)</variable>
      <variable use="model variable" source="expression" name="person.hhincome" type="variable_definition">person.disaggregate(household.income)</variable>
      <variable use="model variable" source="expression" name="person.lhhincome" type="variable_definition">ln(person.disaggregate(household.income))</variable>     
      <variable use="model variable" source="expression" name="person.valid_inc" type="variable_definition">person.disaggregate(household.income &gt; 0)</variable>
      <variable use="model variable" source="expression" name="person.lhhincome_imputed" type="variable_definition">ln(person.disaggregate(urbansim_parcel.household.income_imputed))</variable>
      <variable use="model variable" source="expression" name="person.lhhincome_if_oldest" type="variable_definition">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*(psrc_parcel.person.has_older_sibling==0)</variable>      
      <variable use="model variable" source="expression" name="person.lhhincome_if_not_oldest" type="variable_definition">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*psrc_parcel.person.has_older_sibling</variable>            
      <variable use="model variable" source="expression" name="person.is_high_income" type="variable_definition">person.disaggregate(urbansim_parcel.household.is_high_income_imputed)</variable>
      <variable use="model variable" source="expression" name="person.is_low_income" type="variable_definition">person.disaggregate(urbansim_parcel.household.is_low_income_imputed)</variable>
      <variable use="model variable" source="expression" name="person.hhchild" type="variable_definition">person.disaggregate(household.children)</variable>
      <variable use="model variable" source="expression" name="person.hhchild_oldest" type="variable_definition">person.disaggregate(household.children)*(psrc_parcel.person.has_older_sibling==0)</variable>
      <variable use="model variable" source="expression" name="person.hhworkers" type="variable_definition">person.disaggregate(household.workers)</variable>
      <variable use="model variable" source="expression" name="person.hhnonworkers" type="variable_definition">person.disaggregate(urbansim_parcel.household.number_of_adults-household.workers)</variable>
      <variable use="model variable" source="expression" name="person.has_nonworkers" type="variable_definition">person.disaggregate((urbansim_parcel.household.number_of_adults-household.workers) &gt; 0)</variable>
      <variable use="model variable" source="expression" name="person.timetocbd" type="variable_definition">person.disaggregate(psrc.zone.travel_time_hbw_am_drive_alone_to_cbd, intermediates=[parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.timetocbd_if_oldest" type="variable_definition">person.disaggregate(psrc.zone.travel_time_hbw_am_drive_alone_to_cbd, intermediates=[parcel, building, household])*(psrc_parcel.person.has_older_sibling==0)</variable>      
      <variable use="model variable" source="expression" name="person.timetocbd_if_not_oldest" type="variable_definition">person.disaggregate(psrc.zone.travel_time_hbw_am_drive_alone_to_cbd, intermediates=[parcel, building, household])*psrc_parcel.person.has_older_sibling</variable>           
      <variable use="model variable" source="expression" name="person.lives_in_rural" type="variable_definition">person.disaggregate(numpy.logical_not(parcel.is_inside_urban_growth_boundary), intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.older_sibl_priv" type="variable_definition">psrc_parcel.person.has_older_sibling_in_private_school</variable>
      <variable use="model variable" source="expression" name="person.older_sibl_home" type="variable_definition">psrc_parcel.person.has_older_sibling_in_home_school</variable>
      <variable use="model variable" source="expression" name="person.has_older_sibl" type="variable_definition">psrc_parcel.person.has_older_sibling</variable>
      <variable use="model variable" source="expression" name="person.age_if_older_sibl_priv" type="variable_definition">psrc_parcel.person.has_older_sibling*person.age*psrc_parcel.person.has_older_sibling_in_private_school</variable>
      <variable use="model variable" source="primary attribute" name="person.is_male" type="variable_definition">person.sex==1</variable>
      <variable use="model variable" source="primary attribute" name="person.is_female" type="variable_definition">person.sex==2</variable> 
      <variable use="model variable" source="primary attribute" name="person.sex" type="variable_definition">person.sex</variable>
      <variable use="model variable" source="expression" name="person.valid_age" type="variable_definition">person.age &gt; 0</variable>
      <variable use="model variable" source="expression" name="person.npriv_schools_if_oldest" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_1000_radius, intermediates=[building, household])*(psrc_parcel.person.has_older_sibling==0)</variable>
      <variable use="model variable" source="expression" name="person.npriv_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_2000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.npriv_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_3000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.npriv_s1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_1000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.npriv_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_4000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.is_there_priv_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_4000_radius &gt; 0, intermediates=[building, household]) </variable>
      <variable use="model variable" source="expression" name="person.is_there_priv_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_3000_radius &gt; 0, intermediates=[building, household]) </variable>
      <variable use="model variable" source="expression" name="person.is_there_priv_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_private_schools_within_2000_radius &gt; 0, intermediates=[building, household]) </variable>
      
      <variable use="model variable" source="expression" name="person.npubl_s1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_1000_radius, intermediates=[building, household])</variable> 
      <variable use="model variable" source="expression" name="person.npubl_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_2000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.npubl_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_3000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.npubl_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_4000_radius, intermediates=[building, household])</variable>
      
      <variable use="model variable" source="expression" name="person.ngoodpubl_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_2000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.ngoodpubl_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_3000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.ngoodpubl_s1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_1000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.ngoodpubl_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_4000_radius, intermediates=[building, household])</variable>
      
      <variable use="model variable" source="expression" name="person.no_good_publ_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_3000_radius ==0, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.no_good_publ_s1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_1000_radius ==0, intermediates=[building, household])</variable>      
      <variable use="model variable" source="expression" name="person.no_good_publ_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_2000_radius ==0, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.no_good_publ_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_good_public_schools_within_4000_radius ==0, intermediates=[building, household])</variable>
      
      <variable use="model variable" source="expression" name="person.no_publ_s1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_1000_radius==0, intermediates=[building, household])</variable> 
      <variable use="model variable" source="expression" name="person.no_publ_s2000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_2000_radius==0, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.no_publ_s3000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_3000_radius==0, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.no_publ_s4000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_public_schools_within_4000_radius==0, intermediates=[building, household])</variable>
      
      <variable use="model variable" source="expression" name="person.npubl15min" type="variable_definition">person.disaggregate(psrc_parcel.zone.number_of_public_schools_within_15_minutes_am_walk)</variable>
      <variable use="model variable" source="expression" name="person.nschools_1000" type="variable_definition">person.disaggregate(psrc_parcel.parcel.number_of_schools_within_1000_radius, intermediates=[building, household])</variable>
      <variable use="model variable" source="Python class" name="person_x_school.travel_distance_to_school" type="variable_definition">psrc_parcel.person_x_school.network_distance_from_home_to_school</variable>
      <variable use="model variable" source="Python class" name="person_x_school.walking_time_to_school" type="variable_definition">psrc_parcel.person_x_school.am_total_transit_time_walk_from_home_to_school</variable>
      <variable use="model variable" source="Python class" name="person_x_school.sq_walking_time_to_school" type="variable_definition">numpy.square(psrc_parcel.person_x_school.am_total_transit_time_walk_from_home_to_school)</variable>
      <variable use="model variable" source="Python class" name="person_x_school.sq_distance_to_school" type="variable_definition">numpy.square(psrc_parcel.person_x_school.euclidean_distance_from_home_to_school)</variable>
      <variable use="model variable" source="expression" name="person.faz_school_totscore" type="variable_definition">person.disaggregate(psrc_parcel.faz.average_school_total_score, intermediates=[zone, parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.faz_school_mathscore" type="variable_definition">person.disaggregate(psrc_parcel.faz.average_school_math_index, intermediates=[zone, parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.faz_school_readscore" type="variable_definition">person.disaggregate(psrc_parcel.faz.average_school_reading_index, intermediates=[zone, parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.faz_school_hasscore" type="variable_definition">person.disaggregate(faz.aggregate(school.total_score > 0, intermediates=[parcel, zone])>0, intermediates=[zone, parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.zone_school_totscore" type="variable_definition">person.disaggregate(psrc_parcel.zone.average_school_total_score, intermediates=[parcel, building, household])</variable>
      <variable use="model variable" source="expression" name="person.schooldistr_totscore" type="variable_definition">person.disaggregate(psrc_parcel.parcel.average_school_district_total_score, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="person.schooldistr_readscore" type="variable_definition">person.disaggregate(psrc_parcel.parcel.average_school_district_reading_index, intermediates=[building, household])</variable>
      <variable use="model variable" source="expression" name="school.totscore" type="variable_definition">school.total_score</variable>
      <variable use="model variable" source="expression" name="school.valid_totscore" type="variable_definition">school.total_score &gt; 0</variable>
      <variable use="model variable" source="expression" name="school.mathscore" type="variable_definition">school.math_index</variable>
      <variable use="model variable" source="expression" name="school.valid_mathscore" type="variable_definition">school.math_index &gt; 0</variable>
       <variable use="model variable" source="expression" name="school.readscore" type="variable_definition">school.reading_index</variable>
      <variable use="model variable" source="expression" name="school.notvalid_readscore" type="variable_definition">school.reading_index &lt;= 0</variable>
 	<variable use="model variable" source="expression" name="person_x_school.lhhincome_x_totscore" type="variable_definition">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*school.total_score</variable>
      <variable use="model variable" source="expression" name="person_x_school.lhhincome_x_readscore" type="variable_definition">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*school.reading_index</variable>
      <variable use="model variable" source="expression" name="school.otherscore" type="variable_definition">school.total_score - school.reading_index</variable>
      <variable use="model variable" source="expression" name="person_x_school.age_x_otherscore" type="variable_definition">person.age*(school.total_score - school.reading_index)</variable>
	<variable name="school.wealthshare" source="expression" type="variable_definition" use="model variable">school.disaggregate(psrc_parcel.parcel.percent_wealth_wwd)</variable>
	<variable name="school.povertyshare" source="expression" type="variable_definition" use="model variable">school.disaggregate(psrc_parcel.parcel.percent_poverty_wwd)</variable>
	<variable name="person_x_school.income_x_wealthshare" source="expression" type="variable_definition" use="model variable">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*school.disaggregate(psrc_parcel.parcel.percent_wealth_wwd)</variable>
	<variable name="person_x_school.high_income_x_wealthshare" source="expression" type="variable_definition" use="model variable">ln(person.disaggregate(urbansim.household.is_high_income))*school.disaggregate(psrc_parcel.parcel.percent_wealth_wwd)</variable>
    <variable name="person_x_school.same_school_district" source="expression" type="variable_definition" use="model variable">psrc_parcel.person_x_school.same_school_district</variable>
	<variable name="person_x_school.income_x_povertyshare" source="expression" type="variable_definition" use="model variable">ln(person.disaggregate(urbansim_parcel.household.income_imputed))*school.disaggregate(psrc_parcel.parcel.percent_poverty_wwd)</variable>
      <variable use="model variable" source="expression" name="person_x_school.traveldist_if_out_distr" type="variable_definition">psrc_parcel.person_x_school.network_distance_from_home_to_school*numpy.logical_not(psrc_parcel.person_x_school.same_school_district)</variable>
      <variable use="model variable" source="expression" name="person_x_school.walktime_if_same_distr" type="variable_definition">psrc_parcel.person_x_school.am_total_transit_time_walk_from_home_to_school*psrc_parcel.person_x_school.same_school_district</variable>
    <variable use="model variable" source="Python class" name="person_x_school.ln_travel_distance_to_school" type="variable_definition">ln_shifted(psrc_parcel.person_x_school.network_distance_from_home_to_school)</variable>
    <variable use="model variable" source="Python class" name="school.ln_staff" type="variable_definition">ln_shifted(school.staff)</variable>
      </expression_library>
    <available_datasets type="list">['school', 'person', 'mode','person_trip','building','parcel','household_x_building','zone','faz','large_area','gridcell','city','county','alldata', 'person_trip_x_zone', 'household']</available_datasets>
 </general>
 <model_manager>
  <models config_name="model_system" hidden="False" name="Models" setexpanded="True" type="dictionary">

   <model name="home_school_for_younger_children_model" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.home_school_model</class_module>
            <class_name type="string">HomeSchoolModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">HomeSchoolModel</name>
            <argument name="choice_set" type="string">[0,1]</argument>
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.mnl_probabilities</argument>
            <argument name="choices" parser_action="quote_string" type="string">opus_core.random_choices</argument>
            <argument convert_blank_to_none="True" field_description="test description" name="submodel_string" type="string" model_dependency_type="variable"></argument>
            <argument name="choice_attribute_name" parser_action="quote_string" type="string" model_dependency_type="variable">home_school</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
          </init>
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="agents_index" type="string">hs_index</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string"/>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients, hs_index)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_not_oldest = psrc_parcel.person.has_older_sibling_in_school * (person.student==1)</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">home_school_for_younger_children_model_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">home_school_for_younger_children_model_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">sfilter = psrc_parcel.person.has_older_sibling_in_school * numpy.logical_and(person.is_in_school, numpy.logical_or(person.stype == 2, person.stype == 6))</argument>
            <!--<argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(psrc_parcel.person.has_older_sibling, numpy.logical_and(person.is_in_school, numpy.logical_or(person.stype == 2, person.stype == 6))) </argument>-->
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string" model_dependency_type="table">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string" model_dependency_type="table">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string" model_dependency_type="table">school_type_choice_model_specification</argument>
          </prepare_for_estimate>
    </structure>
        <specification type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
             <equation equation_id="1" name="private" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <!--  <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>
                 <variable_spec name="person.is_high_income" coefficient_name="is_high_income"/>
                 <variable_spec name="person.is_low_income" coefficient_name="is_low_income"/>
                <variable_spec name="person.age" coefficient_name="age"/>
                <variable_spec name="person.is_male" coefficient_name="is_male"/>
                <variable_spec name="person.lives_in_rural"/>
                <variable_spec name="person.timetocbd"/>
                <variable_spec name="person.has_nonworkers" coefficient_name="has_nonworkers"/>                                
                <variable_spec name="person.hhchild" coefficient_name="children"/>  
                <variable_spec name="person.has_older_sibl"/> 
                <variable_spec name="person.npriv_schools"/>
                <variable_spec name="person.zone_school_totscore"/>
                <variable_spec name="person.no_good_publ_schools"/>
                <variable_spec name="person.npubl_schools"/>
                <variable_spec name="person.hhchild_oldest" coefficient_name="children_if_oldest"/>  -->       
                <variable_spec name="person.older_sibl_home"/>
              </variable_list>
            </equation>
          </submodel>
        </specification>
</model>
 <model name="home_school_for_oldest_child_model" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.home_school_model</class_module>
            <class_name type="string">HomeSchoolModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">HomeSchoolModel</name>
            <argument name="choice_set" type="string">[0,1]</argument>
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.mnl_probabilities</argument>
            <argument name="choices" parser_action="quote_string" type="string">opus_core.random_choices</argument>
            <argument convert_blank_to_none="True" field_description="test description" name="submodel_string" type="string"/>
            <argument name="choice_attribute_name" parser_action="quote_string" type="string" model_dependency_type="variable">home_school</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
          </init>
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="agents_index" type="string">hs_index</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string"/>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients, hs_index)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_oldest_student = (psrc_parcel.person.has_older_sibling_in_school==0) * (person.student==1)</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">home_school_for_oldest_child_model_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">home_school_for_oldest_child_model_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">sfilter = (psrc_parcel.person.has_older_sibling_in_school==0) * numpy.logical_and(person.is_in_school, numpy.logical_or(person.stype == 2, person.stype == 6))</argument>
            <!--<argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(psrc_parcel.person.has_older_sibling, numpy.logical_and(person.is_in_school, numpy.logical_or(person.stype == 2, person.stype == 6))) </argument>-->
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string" model_dependency_type="table">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string" model_dependency_type="table">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string" model_dependency_type="table">school_type_choice_model_specification</argument>
          </prepare_for_estimate>
    </structure>
        <specification type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
             <equation equation_id="1" name="private" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <!-- <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>
                 <variable_spec name="person.is_high_income" coefficient_name="is_high_income"/>
                 <variable_spec name="person.is_low_income" coefficient_name="is_low_income"/>
                <variable_spec name="person.age" coefficient_name="age"/>
                <variable_spec name="person.is_male" coefficient_name="is_male"/>
                <variable_spec name="person.lives_in_rural"/>
                <variable_spec name="person.timetocbd"/>                               
                <variable_spec name="person.has_older_sibl"/> 
                <variable_spec name="person.npriv_schools"/>
                <variable_spec name="person.zone_school_totscore"/>
                <variable_spec name="person.no_good_publ_schools"/>
                <variable_spec name="person.npubl_schools"/> 
                <variable_spec name="person.hhchild_oldest" coefficient_name="children_if_oldest"/>          
                <variable_spec name="person.older_sibl_home"/>                 
                <variable_spec name="person.schooldistr_totscore"/> --> 
                <variable_spec name="person.has_nonworkers" coefficient_name="has_nonworkers"/>         
                <variable_spec name="person.hhchild" coefficient_name="children"/>
              </variable_list>
            </equation>
          </submodel>
        </specification>
</model>
<model name="public_private_school_for_oldest_child_model" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_type_choice_model</class_module>
            <class_name type="string">SchoolTypeChoiceModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolTypeChoiceModel</name>
            <argument name="choice_set" type="string">[1,2]</argument>
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.mnl_probabilities</argument>
            <argument name="choices" parser_action="quote_string" type="string">opus_core.random_choices</argument>
            <argument convert_blank_to_none="True" field_description="test description" name="submodel_string" type="string"/>
            <argument name="choice_attribute_name" parser_action="quote_string" type="string">school_type</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
          </init>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients, pp_index)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_oldest_student = (psrc_parcel.person.has_older_sibling_in_school==0) * (person.student &lt; 3) * (person.home_school&lt;=0) * (person.age &lt;= 18)</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">public_private_school_for_oldest_child_model_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">public_private_school_for_oldest_child_model_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>          
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string">person</argument>
            <argument name="agents_index" type="string">pp_index</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string"/>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = (psrc_parcel.person.has_older_sibling_in_school==0) * psrc_parcel.person.is_in_private_or_public_k12_school</argument>
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_type_choice_model_specification</argument>
          </prepare_for_estimate>
    </structure>
        <specification type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
             <equation equation_id="2" name="private" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <!--<variable_spec name="person.hhnonworkers" coefficient_name="nonworkers"/>                
                <variable_spec name="person.has_older_sibl"/>
                
                <variable_spec name="person.faz_school_hasscore"/>

                <variable_spec name="person.age_if_older_sibl_priv"/>
                <variable_spec name="person.older_sibl_priv"/>  

                <variable_spec name="person.age" coefficient_name="age"/>
                <variable_spec name="person.is_male" coefficient_name="is_male"/>
                <variable_spec name="person.lives_in_rural"/>
                <variable_spec name="person.has_nonworkers" coefficient_name="has_nonworkers"/>               
                <variable_spec name="person.is_high_income"/>
                <variable_spec name="person.is_low_income" />
                <variable_spec name="person.hhchild" coefficient_name="children"/> 
                <variable_spec name="person.faz_school_totscore"/>                 
                <variable_spec name="person.faz_school_mathscore"/> 

                <variable_spec name="person.no_good_publ_s4000"/>
                <variable_spec name="person.no_good_publ_s3000"/>
                <variable_spec name="person.no_good_publ_s1000"/>
                <variable_spec name="person.no_publ_s4000"/>
                <variable_spec name="person.no_publ_s3000"/>
                <variable_spec name="person.no_publ_s1000"/>

                <variable_spec name="person.npriv_s1000"/>
                <variable_spec name="person.npriv_s3000"/>
                <variable_spec name="person.npubl_s4000"/>
                <variable_spec name="person.npubl_s1000"/>
                <variable_spec name="person.npubl_s3000"/>
                <variable_spec name="person.ngoodpubl_s4000"/>

                <variable_spec name="person.ngoodpubl_s1000"/>
                <variable_spec name="person.npubl15min"/>
                               
                <variable_spec name="person.zone_school_totscore"/>   -->        
                <variable_spec name="person.schooldistr_readscore"/>                  
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>                
                <variable_spec name="person.timetocbd"/>
                <variable_spec name="person.npriv_s3000"/>
              <!--   <variable_spec name="person.is_there_priv_s3000"/>
               <variable_spec name="person.npriv_s4000"/>
                 <variable_spec name="person.ngoodpubl_s3000"/> -->

              </variable_list>
            </equation>
          </submodel>
        </specification>
  </model>
  <model name="public_private_school_for_younger_children_model" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_type_choice_model</class_module>
            <class_name type="string">SchoolTypeChoiceModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolTypeChoiceModel</name>
            <argument name="choice_set" type="string">[1,2]</argument>
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.mnl_probabilities</argument>
            <argument name="choices" parser_action="quote_string" type="string">opus_core.random_choices</argument>
            <argument convert_blank_to_none="True" field_description="test description" name="submodel_string" type="string"/>
            <argument name="choice_attribute_name" parser_action="quote_string" type="string">person.school_type</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
          </init>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients, pp_index)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_not_oldest = psrc_parcel.person.has_older_sibling_in_school * (person.student &lt; 3) * (person.home_school&lt;=0) * (person.age &lt;=18) </argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">public_private_school_for_younger_children_model_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">public_private_school_for_younger_children_model_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>   
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string">person</argument>
            <argument name="agents_index" type="string">pp_index</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string"/>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = psrc_parcel.person.has_older_sibling_in_school * psrc_parcel.person.is_in_private_or_public_k12_school * (person.age &lt;=18) </argument>
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_type_choice_model_specification</argument>
          </prepare_for_estimate>
    </structure>
        <specification type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
             <equation equation_id="2" name="private" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <!--<variable_spec name="person.hhnonworkers" coefficient_name="nonworkers"/>                
                <variable_spec name="person.has_older_sibl"/>                
                <variable_spec name="person.faz_school_hasscore"/>
                <variable_spec name="person.age_if_older_sibl_priv"/>
                <variable_spec name="person.age" coefficient_name="age"/>
                <variable_spec name="person.is_male" coefficient_name="is_male"/>
                <variable_spec name="person.lives_in_rural"/>
                <variable_spec name="person.has_nonworkers" coefficient_name="has_nonworkers"/>               
                <variable_spec name="person.is_high_income"/>
                <variable_spec name="person.is_low_income" />
                <variable_spec name="person.hhchild" coefficient_name="children"/> 
                <variable_spec name="person.faz_school_totscore"/>                 
                <variable_spec name="person.faz_school_mathscore"/> 

                <variable_spec name="person.no_good_publ_s3000"/>
                <variable_spec name="person.no_good_publ_s1000"/>
                <variable_spec name="person.no_good_publ_s4000"/>
                <variable_spec name="person.no_publ_s4000"/>
                <variable_spec name="person.no_publ_s3000"/>
                <variable_spec name="person.no_publ_s1000"/>

                <variable_spec name="person.npriv_s1000"/>
                <variable_spec name="person.npriv_s3000"/>
                <variable_spec name="person.npriv_s4000"/>
                <variable_spec name="person.npubl_s4000"/>
                <variable_spec name="person.npubl_s1000"/>
                <variable_spec name="person.npubl_s3000"/>
                <variable_spec name="person.ngoodpubl_s4000"/>

                <variable_spec name="person.ngoodpubl_s1000"/>
                <variable_spec name="person.npubl15min"/>
                               
                <variable_spec name="person.zone_school_totscore"/>   
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>   
                <variable_spec name="person.timetocbd"/>
               <variable_spec name="person.ngoodpubl_s3000"/>
                --> 
                <variable_spec name="person.older_sibl_priv"/>                        
             </variable_list>
            </equation>
          </submodel>
        </specification>
  </model>
       <model name="postprocess_public_private_school_for_oldest_child_model" type="model">
        <dependencies type="list">['public_private_school_for_oldest_child_model']</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">(person.school_type==2)* (psrc_parcel.person.has_older_sibling + (psrc_parcel.person.has_older_sibling==0))</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">is_in_private_k12_school</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
        <specification type="dictionary"/>
      </model>
      <model name="school_type_choice_model_nested" type="model">
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_type_choice_model</class_module>
            <class_name type="string">SchoolTypeChoiceModelNested</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolTypeChoiceModelNested</name>
            <argument name="choice_set" type="string">[1,2,3]</argument>
            <argument name="nested_structure" type="string">{1: [3], 2: [1,2]}</argument>
           <!-- <argument name="nested_structure" type="string">{1: [2,3], 2: [1]}</argument>-->
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.hierarchical_linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.nl_probabilities</argument>
            <argument name="choices" parser_action="quote_string" type="string">opus_core.random_choices</argument>
            <argument convert_blank_to_none="True" field_description="test description" name="submodel_string" type="string"/>
            <argument name="choice_attribute_name" parser_action="quote_string" type="string">school_type</argument>
            <argument name="interaction_pkg" parser_action="quote_string" type="string">opus_core</argument>
            <argument convert_blank_to_none="True" name="run_config" type="string"/>
            <argument name="estimate_config" type="dictionary">
              <key name="estimation_size_agents" type="float">1.0</key>
              <key name="starting_values" type="dictionary">
                <key name="__logsum_1" type="tuple">
                  <initvalue type="float">1</initvalue>
                  <doestimate type="boolean">False</doestimate>
                </key>
                <key name="__logsum_2" type="tuple">
                  <initvalue type="float">1</initvalue>
                  <doestimate type="boolean">True</doestimate>
                </key>
              </key>
            </argument>
            <argument name="debuglevel" type="integer">0</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </init>
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string">person</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string"/>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients, cm_index)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string"/>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_type_choice_model_nested_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">school_type_choice_model_nested_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bfgs_nl_estimation</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
            <argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(psrc_parcel.person.has_older_sibling==0, numpy.logical_and(person.is_in_school, numpy.logical_or(person.stype == 2, person.stype == 6))) </argument>
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_type_choice_model_nested_specification</argument>
          </prepare_for_estimate>
        </structure>
        <specification type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
          <nest nest_id="2" name="public-private">
            <equation equation_id="1" name="public" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <!--<variable_spec name="person.timetocbd" coefficient_name="timetocbd"/>
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome_1"/> -->
              </variable_list>
            </equation>
            <equation equation_id="2" name="private" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome_2"/>
                <variable_spec name="person.timetocbd" coefficient_name="timetocbd_2"/>
                <!--<variable_spec name="person.valid_inc" coefficient_name="valid_inc_2"/>
                <variable_spec name="person.hhworkers" coefficient_name="workers"/>
                <variable_spec name="person.age" coefficient_name="age_2"/>
                <variable_spec name="person.is_male" coefficient_name="is_male_2"/>!-->                
              </variable_list>
            </equation>
          </nest>
          <nest nest_id="1" name="home school">
            <equation equation_id="3" name="home school">
               <variable_list type="variable_list">
                   <!-- <variable_spec name="constant" coefficient_name="constant_3"/>!-->
                  <variable_spec name="person.hhchild" coefficient_name="children_3"/>
                  <!--<variable_spec name="person.is_male" coefficient_name="is_male_3"/>
                  <variable_spec name="person.hhnonworkers" coefficient_name="hhnonworkers_3"/>!-->
                  <!-- <variable_spec name="person.timetocbd" coefficient_name="timetocbd_3"/>!-->
                </variable_list>
            </equation>
          </nest>
        </submodel>
      </specification>
      <specification_test type="dictionary">
          <submodel hidden="Children" name="submodel" submodel_id="-2" type="submodel">
          <nest nest_id="2" name="public">
            <equation equation_id="1" name="public" type="submodel_equation">
              <variable_list type="variable_list">
                <variable_spec name="constant" coefficient_name="constant"/>
                <variable_spec name="person.timetocbd" coefficient_name="timetocbd_1"/>
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome_1"/>
              </variable_list>
            </equation>
            </nest>
            <nest nest_id="1" name="private - home school">
            <equation equation_id="2" name="private" type="submodel_equation">
              <variable_list type="variable_list">
               <!-- <variable_spec name="constant" coefficient_name="constant"/>-->
                <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome_2"/>
                <variable_spec name="person.timetocbd" coefficient_name="timetocbd_2"/>
                <!--<variable_spec name="person.hhworkers" coefficient_name="workers"/>!-->
                <!--<variable_spec name="person.age" coefficient_name="age"/>!-->
                <!--<variable_spec name="person.is_male" coefficient_name="is_male_2"/>-->
                <!--<variable_spec name="person.timetocbd" coefficient_name="timetocbd_2"/>
                <variable_spec name="person.older_sibl_priv" coefficient_name="older_sibl_priv_2"/>
                <variable_spec name="person.has_older_sibl" coefficient_name="has_older_sibl_2"/>-->
              </variable_list>
            </equation>
          
            <equation equation_id="3" name="home school">
               <variable_list type="variable_list">
                  <variable_spec name="constant" coefficient_name="constant"/>
                  <variable_spec name="person.hhchild" coefficient_name="children_3"/>
                  <!-- <variable_spec name="person.valid_hhchild" coefficient_name="valid_children_3"/>
                  <variable_spec name="person.is_male" coefficient_name="is_male_3"/>!-->
                  <!-- <variable_spec name="person.timetocbd" coefficient_name="timetocbd_3"/>
                  <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>
                  <variable_spec name="person.has_nonworkers" coefficient_name="has_nonworkers_3"/>
                  <variable_spec name="person.age" coefficient_name="age"/>!-->
                </variable_list>
            </equation>
          </nest>
        </submodel>
      </specification_test>
        <estimation_config name="Estimation Configuration" parser_action="skip">
          <config_override config_name="models" name="Models to run before estimation" type="list">[]</config_override>
        </estimation_config>
      </model>
 <model name="school_choice_model_public" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_choice_model</class_module>
            <class_name type="string">SchoolChoiceModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolChoiceModel</name>
            <argument name="location_set" type="string" model_dependency_type="dataset">school</argument>
           <!-- <argument name="filter" parser_action="quote_string" type="string" model_dependency_type="variable">school.public * (school.school_district_id == GROUP)</argument>-->
             <argument name="filter" parser_action="quote_string" type="string" model_dependency_type="variable">school.public * psrc_parcel.school.is_in_category_SUBMODEL * (school.school_district_id == GROUP)</argument> 
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.upc.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.upc.mnl_probabilities</argument>
            <!-- <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.lottery_choices</argument> -->
           <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.random_choices_from_index</argument>
           <!-- <argument name="sampler" parser_action="quote_string" type="string">opus_core.samplers.weighted_sampler</argument>--> 
             <argument name="sampler" parser_action="quote_string" type="string" convert_blank_to_none="True"></argument>  
            <argument convert_blank_to_none="True" name="submodel_string" parser_action="quote_string" type="string">psrc_parcel.person.age_category</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
            <argument name="availability" type="string" parser_action="quote_string" convert_blank_to_none="True" model_dependency_type="variable">(psrc_parcel.person.school_district_id == school.school_district_id) * psrc_parcel.school.is_in_category_SUBMODEL</argument>
            <argument name="run_config" type="dictionary">
              <!-- <key name="sample_size_locations" type="integer">7</key> -->
              <key name="compute_capacity_flag" type="boolean">False</key>
              <key name="capacity_string" type="string">15*clip_to_zero(school.student_count - school.number_of_agents(person))</key>
              <key name="filter_by_groups" type="boolean" convert_blank_to_none="True">True</key>
              <key name="group_definition_for_filtering_alternatives" type="string" convert_blank_to_none="True">psrc_parcel.person.school_district_id</key>
              <key name="lottery_max_iterations" type="integer">10</key>      
            </argument>
            <argument name="estimate_config" type="dictionary">
              <!-- <key name="weights_for_estimation_string" type="string" convert_blank_to_none="True">school.student_count * (psrc_parcel.person.school_district_id == school.school_district_id)</key> -->
              <!-- <key name="weights_for_estimation_string" type="string" convert_blank_to_none="True" model_dependency_type="variable">psrc_parcel.person.school_district_id == school.school_district_id</key>-->
             <!-- <key name="sample_size_locations" type="integer">7</key> -->
              <key name="filter_by_groups" type="boolean" convert_blank_to_none="True">True</key>
              <key name="group_definition_for_filtering_alternatives" type="string" convert_blank_to_none="True">psrc_parcel.person.school_district_id</key>
            </argument>
          </init>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_choice_model_public_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">school_choice_model_public_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>   
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agents_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school = (person.student &lt; 3) * (person.school_type==1) * ((psrc_parcel.person.age_category==2) + (psrc_parcel.person.age_category==3) + (psrc_parcel.person.age_category==4))</argument>            
            <argument name="chunk_specification" type="string">{'records_per_chunk':50000}</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument> 
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
             <argument convert_blank_to_none="True" name="agents_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(numpy.logical_and(person.stype == 2, psrc_parcel.person.is_in_public_school), psrc_parcel.person.school_district_id == person.disaggregate(school.school_district_id))</argument> 
            <!--<argument convert_blank_to_none="True" name="agent_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(person.stype == 2, psrc_parcel.person.is_in_public_school)</argument>-->
            
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_choice_model_public_specification</argument>
          </prepare_for_estimate>
    </structure>
    <specification type="dictionary">
          <submodel hidden="Children" name="elementary" submodel_id="2" type="submodel">
               <variable_list type="variable_list">
             <!--  <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>--> 
              <!--  <variable_spec name="person_x_school.travel_distance_to_school"/>-->
                 <variable_spec name="person_x_school.sq_walking_time_to_school"/> 
               <!--   <variable_spec name="person_x_school.sq_distance_to_school"/>  -->
            <!--    <variable_spec name="school.totscore"/> 
                <variable_spec name="school.valid_totscore"/>
              <variable_spec name="person_x_school.lhhincome_x_totscore"/>  -->
               <!-- <variable_spec name="school.mathscore"/>
                <variable_spec name="school.valid_mathscore"/>
                <variable_spec name="school.readscore"/>-->
            <!--    <variable_spec name="person_x_school.lhhincome_x_readscore"/>               
             <variable_spec name="school.notvalid_readscore"/>-->
       <!--  <variable_spec name="school.otherscore"/>
             <variable_spec name="person_x_school.age_x_otherscore"/>  -->
              </variable_list>
          </submodel>
          <submodel hidden="Children" name="middle" submodel_id="3" type="submodel">
          <variable_list type="variable_list">
          	<variable_spec name="person_x_school.walking_time_to_school"/> 
        <!-- 	<variable_spec name="person_x_school.travel_distance_to_school"/>
         <variable_spec name="person_x_school.sq_distance_to_school"/> -->
          	</variable_list>
          </submodel>
          <submodel hidden="Children" name="high" submodel_id="4" type="submodel">
          <variable_list type="variable_list">
        	<variable_spec name="person_x_school.sq_walking_time_to_school"/> 
           <!--	<variable_spec name="person_x_school.travel_distance_to_school"/>
          <variable_spec name="person_x_school.sq_distance_to_school"/> -->
          	</variable_list>
          </submodel>
        </specification>
</model>
 <model name="school_choice_model_public_no_schools_in_district" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_choice_model</class_module>
            <class_name type="string">SchoolChoiceModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolChoiceModel</name>
            <argument name="location_set" type="string" model_dependency_type="dataset">school</argument>
             <argument name="filter" parser_action="quote_string" type="string" model_dependency_type="variable">school.public * psrc_parcel.school.is_in_category_SUBMODEL</argument> 
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.upc.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.upc.mnl_probabilities</argument>
            <!-- <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.lottery_choices</argument> -->
           <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.random_choices_from_index</argument>
            <argument name="sampler" parser_action="quote_string" type="string">opus_core.samplers.weighted_sampler</argument> 
            <argument convert_blank_to_none="True" name="submodel_string" parser_action="quote_string" type="string">psrc_parcel.person.age_category</argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
            <argument name="availability" type="string" parser_action="quote_string" convert_blank_to_none="True" model_dependency_type="variable">psrc_parcel.school.is_in_category_SUBMODEL</argument>
            <argument name="run_config" type="dictionary">
              <key name="sample_size_locations" type="integer">50</key>
              <key name="compute_capacity_flag" type="boolean">False</key>
              <key name="capacity_string" type="string">15*clip_to_zero(school.student_count2014  - school.number_of_agents(person))</key>
	      <key name="weights_for_simulation_string" type="string">clip_to_zero(school.student_count2014  - school.number_of_agents(person))</key>
              <key name="lottery_max_iterations" type="integer">10</key>      
            </argument>
          </init>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_choice_model_public_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">school_choice_model_public_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>   
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument convert_blank_to_none="True" name="agents_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_without_school = (person.student &lt; 3) * (person.school_type==1) * (person.school_id &lt; 0) * ((psrc_parcel.person.age_category==2) + (psrc_parcel.person.age_category==3) + (psrc_parcel.person.age_category==4))</argument>            
            <argument name="chunk_specification" type="string">{'records_per_chunk':10000}</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
    </structure>
</model>
 <model name="school_choice_model_private_for_oldest_child" type="model">
     <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.school_choice_model</class_module>
            <class_name type="string">SchoolChoiceModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SchoolChoiceModel</name>
            <argument name="location_set" type="string" model_dependency_type="dataset">school</argument>
            <argument name="filter" parser_action="quote_string" type="string" model_dependency_type="variable">(school.public==0)*psrc_parcel.school.is_in_category_GROUP</argument>
            <argument name="utilities" parser_action="quote_string" type="string">opus_core.linear_utilities</argument>
            <argument name="probabilities" parser_action="quote_string" type="string">opus_core.mnl_probabilities</argument>
            <!-- <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.lottery_choices</argument> -->
            <argument name="choices" parser_action="quote_string" type="string">opus_core.upc.random_choices_from_index</argument>
            <argument name="sampler" parser_action="quote_string" type="string">opus_core.samplers.weighted_sampler</argument> 
            <!-- <argument name="sampler" parser_action="quote_string" type="string" convert_blank_to_none="True"></argument> -->
            <argument convert_blank_to_none="True" name="submodel_string" parser_action="quote_string" type="string"></argument>
            <argument name="debuglevel" type="string" hidden="True">debuglevel</argument>
            <argument name="dataset_pool" type="string" hidden="True">dataset_pool</argument>
            <argument name="run_config" type="dictionary">
              <key name="sample_size_locations" type="integer">100</key>
              <key name="sample_alternatives_by_group" type="boolean">True</key>
              <key name="group_definition_for_sampling_alternatives" type="string" convert_blank_to_none="True">psrc_parcel.person.age_category</key>
              <key name="compute_capacity_flag" type="boolean">False</key>
              <key name="capacity_string" type="string">15*clip_to_zero(school.student_count2014  - school.number_of_agents(person))</key>
	      <key name="weights_for_simulation_string" type="string">clip_to_zero(school.student_count2014 - school.number_of_agents(person))</key>
              <key name="lottery_max_iterations" type="integer">10</key>
              <key name="number_of_units_string" type="string">number_of_students=school.number_of_agents(person)</key>
            </argument>
            <argument name="estimate_config" type="dictionary">
              <!--  <key name="weights_for_estimation_string" type="string" convert_blank_to_none="True">school.student_count</key>-->
              <key name="weights_for_estimation_string" type="string" convert_blank_to_none="True">school.student_count2014</key>
              <key name="sample_size_locations" type="integer">100</key>
              <key name="sample_alternatives_by_group" type="boolean">True</key>
              <key name="group_definition_for_sampling_alternatives" type="string" convert_blank_to_none="True">psrc_parcel.person.age_category</key>
            
              <!--<key name="agent_category_definition" type="list">['person.disaggregate(parcel.school_district_id, intermediates=[building, household])']</key>
              <key name="choice_category_definition" type="list">['school.disaggregate(parcel.school_district_id)']</key>
              <key name="agent_filter_attribute" type="string">person.disaggregate(parcel.school_district_id, intermediates=[building, household])&gt;0</key>-->
            </argument>
          </init>
          <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(specification, coefficients)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_choice_model_private_for_oldest_child_specification</argument>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" parser_action="quote_string" type="string">school_choice_model_private_for_oldest_child_coefficients</argument>
            <argument name="cache_storage" type="string">base_cache_storage</argument>
          </prepare_for_run>   
          <run type="dictionary">
            <argument name="specification" type="string">specification</argument>
            <argument name="coefficients" type="string">coefficients</argument>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="agents_filter" type="string" parser_action="quote_string" convert_blank_to_none="True">is_student_in_private_school = (person.student &lt; 3) * (person.school_type==2) * ((psrc_parcel.person.age_category==2) + (psrc_parcel.person.age_category==3) + (psrc_parcel.person.age_category==4)) * (psrc_parcel.person.has_older_sibling_own_age_category_in_private_school==0)</argument>
            <argument convert_blank_to_none="True" name="chunk_specification" type="string">{'records_per_chunk':50000}</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </run>
          <estimate type="dictionary">
            <output name="output" type="string">(coefficients, dummy)</output>
            <argument name="specification" type="string">specification</argument>
            <argument name="agent_set" type="string">est_dataset</argument>
            <argument name="agents_index" type="string">cm_index</argument>
            <argument name="procedure" parser_action="quote_string" type="string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="data_objects" type="string">datasets</argument>
          </estimate>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(specification, cm_index, est_dataset)</output>
            <argument convert_blank_to_none="True" name="agent_set" type="string">person</argument>
             <argument convert_blank_to_none="True" name="agents_filter" parser_action="quote_string" type="string">sfilter = numpy.logical_and(numpy.logical_and(person.stype == 2, psrc_parcel.person.is_in_private_school), psrc_parcel.person.has_older_sibling_own_age_category_in_private_school==0) * ((psrc_parcel.person.age_category==2) + (psrc_parcel.person.age_category==3) + (psrc_parcel.person.age_category==4))</argument>             
            <argument name="agents_for_estimation_table" parser_action="quote_string" type="string">persons_for_estimation</argument>
            <argument name="estimation_storage" type="string">base_cache_storage</argument>
            <argument name="households_for_estimation_table" parser_action="quote_string" type="string">households_for_estimation</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" parser_action="quote_string" type="string">school_choice_model_private_specification</argument>
          </prepare_for_estimate>
    </structure>
    <specification type="dictionary">
          <submodel hidden="Children" name="private" submodel_id="-2" type="submodel">
               <variable_list type="variable_list">
             <!--  <variable_spec name="person.lhhincome_imputed" coefficient_name="lhhincome"/>--> 
             <!--  
                <variable_spec name="person_x_school.high_income_x_wealthshare"/>               
                <variable_spec name="person_x_school.income_x_wealthshare"/>   -->           
              <!-- <variable_spec name="person_x_school.walking_time_to_school"/>
				<variable_spec name="person_x_school.travel_distance_to_school"/> --> 
			<!--	<variable_spec name="school.povertyshare"/>
			<variable_spec name="person_x_school.income_x_povertyshare"/> --> 
			<variable_spec name="person_x_school.same_school_district"/>
			<variable_spec name="person_x_school.traveldist_if_out_distr"/>
			<variable_spec name="person_x_school.walktime_if_same_distr"/>
              </variable_list>
          </submodel>

        </specification>
</model>
       <model name="school_choice_model_private_for_younger_siblings" type="model">
        <dependencies type="list">['school_choice_model_private_for_oldest_child']</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">psrc_parcel.person.school_of_older_sibling_own_age_category_private</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
            <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_private_school_younger = (person.student &lt; 3) * (person.school_type==2) * ((psrc_parcel.person.age_category==2) + (psrc_parcel.person.age_category==3) + (psrc_parcel.person.age_category==4)) * psrc_parcel.person.has_older_sibling_own_age_category_in_private_school</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
      <model name="school_choice_model_preschool" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.nearest_school_of_category_1, intermediates=[building])</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
           <!-- <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_preschool = (psrc_parcel.person.age_category==1) * person.disaggregate(urbansim_parcel.household.number_of_adults==urbansim_parcel.household.number_of_non_home_based_workers)</argument>-->
           <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_preschool = (psrc_parcel.person.age_category==1) * numpy.logical_or(person.student==1, person.student==2)</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
       <model name="initiate_school_id_in_persons" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">(0 * person.age - 1).astype(int32)</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
      <model name="school_choice_model_public_distance_2" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.nearest_public_school_of_category_2_with_enrollment, intermediates=[building])</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
            <!--<argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_2_without_school = (person.disaggregate(school.student_count2014 &lt;= 0)) * (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==2)</argument>-->
<argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_2 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==2)</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
            <model name="school_choice_model_public_distance_3" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.nearest_public_school_of_category_3_with_enrollment, intermediates=[building])</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
<!--            <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_3_without_school = (person.disaggregate(school.student_count2014 &lt;= 0)) * (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==3)</argument>-->
 <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_3 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==3)</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
      <model name="school_choice_model_public_distance_4" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.nearest_public_school_of_category_4_with_enrollment, intermediates=[building])</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
            <!--<argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_4_without_school = (person.disaggregate(school.student_count2014 &lt;= 0)) * (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==4)</argument>-->
<argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_4 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==4)</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
      </model>
            <model name="school_choice_model_public_assign_2" type="model">
	<dependencies type="list">[]</dependencies>
	<structure type="dictionary">
	  <import name="import" type="dictionary">
	    <class_module type="string">opus_core.simple_model</class_module>
	    <class_name type="string">SimpleModel</class_name>
	  </import>
	  <init type="dictionary">
	    <name name="name" type="string">SimpleModel</name>
	  </init>
	  <run type="dictionary">
	    <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
	    <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.elem_id, intermediates=[building])</argument>
	    <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
	    <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_2 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==2)</argument>
	    <argument name="dataset_pool" type="string">dataset_pool</argument>
	  </run>
	</structure>
      </model>
	    <model name="school_choice_model_public_assign_3" type="model">
	<dependencies type="list">[]</dependencies>
	<structure type="dictionary">
	  <import name="import" type="dictionary">
	    <class_module type="string">opus_core.simple_model</class_module>
	    <class_name type="string">SimpleModel</class_name>
	  </import>
	  <init type="dictionary">
	    <name name="name" type="string">SimpleModel</name>
	  </init>
	  <run type="dictionary">
	    <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
	    <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.mschool_id, intermediates=[building])</argument>
	    <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
	    <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_3 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==3)</argument>
	    <argument name="dataset_pool" type="string">dataset_pool</argument>
	  </run>
	</structure>
      </model>
      <model name="school_choice_model_public_assign_4" type="model">
	<dependencies type="list">[]</dependencies>
	<structure type="dictionary">
	  <import name="import" type="dictionary">
	    <class_module type="string">opus_core.simple_model</class_module>
	    <class_name type="string">SimpleModel</class_name>
	  </import>
	  <init type="dictionary">
	    <name name="name" type="string">SimpleModel</name>
	  </init>
	  <run type="dictionary">
	    <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
	    <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">person.disaggregate(psrc_parcel.parcel.hschool_id, intermediates=[building])</argument>
	    <argument name="outcome_attribute" parser_action="quote_string" type="string">school_id</argument>
	    <argument name="dataset_filter" parser_action="quote_string" type="string" model_dependency_type="variable">is_student_in_public_school_4 = (person.student &lt; 3) * (person.school_type==1) * (psrc_parcel.person.age_category==4)</argument>
	    <argument name="dataset_pool" type="string">dataset_pool</argument>
	  </run>
	</structure>
      </model>
    <model copyable="True" hidden="False" name="college_location_model" type="model" inherit_parent_values="False">
      <structure type="dictionary">
           <import name="import" type="dictionary">
            <class_module type="string">psrc_parcel.models.person_location_choice_model</class_module>
            <class_name type="string">PersonLocationChoiceModel</class_name>
          </import>
          <init type="dictionary">
          <name hidden="True" name="name" type="string">PersonLocationChoiceModel</name>
            <argument name="location_set" type="string" model_dependency_type="dataset">school</argument>
            <argument name="sampler" type="string" parser_action="quote_string">opus_core.samplers.weighted_sampler</argument>
            <argument name="utilities" type="string" parser_action="quote_string">opus_core.linear_utilities</argument>
            <argument name="probabilities" type="string" parser_action="quote_string">opus_core.mnl_probabilities</argument>
            <argument name="choices" type="string" parser_action="quote_string">urbansim.lottery_choices</argument>
            <argument name="filter" type="string" parser_action="quote_string" model_dependency_type="variable" convert_blank_to_none="True"></argument>
            <argument name="submodel_string" type="string" convert_blank_to_none="True" parser_action="quote_string"/>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
            <argument name="model_name" type="string" parser_action="quote_string">College Location Model</argument>
            <argument name="short_name" type="string" parser_action="quote_string">CollegeLM</argument>
            <argument name="variable_package" type="string" parser_action="quote_string">urbansim</argument>
            <argument name="debuglevel" type="string">debuglevel</argument>          
            <argument name="estimate_config" type="dictionary">
              <key name="weights_for_estimation_string" type="string" convert_blank_to_none="True">psrc_parcel.school.sampling_by_residence_large_area_GROUP * psrc_parcel.school.is_in_category_5</key>
              <key name="sample_size_locations" type="integer">100</key>
              <key name="sample_proportion_locations" type="integer" convert_blank_to_none="True"/>
              <key name="estimation_size_agents" type="float">1.0</key>
              <key name="sample_alternatives_by_group" type="boolean">True</key>
              <key name="group_definition_for_sampling_alternatives" type="string" model_dependency_type="variable">urbansim_parcel.person.large_area_id</key>
            </argument>
            <argument name="run_config" type="dictionary">
              <key name="weights_for_simulation_string" type="string" convert_blank_to_none="True">psrc_parcel.school.sampling_by_residence_large_area_GROUP * psrc_parcel.school.is_in_category_5</key>
              <key name="sample_size_locations" type="integer">100</key>
              <key name="sample_proportion_locations" type="integer" convert_blank_to_none="True"/>
              <key name="compute_capacity_flag" type="boolean">True</key>
             <!--  <key name="capacity_string" type="string" convert_blank_to_none="True">clip_to_zero(15*school.staff - school.number_of_agents(person))</key> -->
             <!-- <key name="capacity_string" type="string" convert_blank_to_none="True">clip_to_zero(1.15* school.fte2014 - school.number_of_agents(person))</key>-->
	      <key name="capacity_string" type="string" convert_blank_to_none="True">clip_to_zero(1.3* school.fte2014 - school.number_of_agents(person))</key>
             <!--  <key name="number_of_units_string" type="string" convert_blank_to_none="True">15*school.staff</key>  --> 
            <!--  <key name="number_of_units_string" type="string" convert_blank_to_none="True">1.15* school.fte2010</key> -->
            <!--<key name="number_of_units_string" type="string" convert_blank_to_none="True">1.15*school.fte2014</key>-->
	    <key name="number_of_units_string" type="string" convert_blank_to_none="True">1.3*school.fte2014</key>
              <key name="number_of_agents_string" type="string" convert_blank_to_none="True">school.number_of_agents(person)</key>
              <key name="lottery_max_iterations" type="integer">3</key>
              <key name="sample_alternatives_by_group" type="boolean">True</key>
              <key name="group_definition_for_sampling_alternatives" type="string" model_dependency_type="variable">urbansim_parcel.person.large_area_id</key>
            </argument>
          </init>
           <prepare_for_run type="dictionary">
            <name name="name" type="string">prepare_for_run</name>
            <output name="output" type="string">(collcm_specification, collcm_coefficients)</output>
            <argument name="coefficients_storage" type="string">base_cache_storage</argument>
            <argument name="coefficients_table" type="string" parser_action="quote_string" model_dependency_type="table">college_location_model_coefficients</argument>
            <argument name="specification_storage" type="string">base_cache_storage</argument>
            <argument name="specification_table" type="string" parser_action="quote_string" model_dependency_type="table">college_location_model_specification</argument>
          </prepare_for_run>
          <run type="dictionary">
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <!--<argument name="agents_filter" type="string" convert_blank_to_none="True" parser_action="quote_string" model_dependency_type="variable">is_student_in_college_with_residence = (person.student &lt; 3) * (person.student &gt; 0) * (psrc_parcel.person.age_category==5) * (urbansim_parcel.person.building_id &gt; 0)</argument>-->
	    <argument name="agents_filter" type="string" convert_blank_to_none="True" parser_action="quote_string" model_dependency_type="variable">is_student_in_college_with_residence = (person.student == 1) * (person.employment_status &lt;&gt; 1) * (psrc_parcel.person.age_category==5) * (urbansim_parcel.person.building_id &gt; 0)</argument>
            <argument name="chunk_specification" type="string">{'records_per_chunk':50000}</argument>
            <argument name="coefficients" type="string">collcm_coefficients</argument>
            <argument name="specification" type="string">collcm_specification</argument>     
            <argument name="maximum_runs" type="integer">5</argument>
          </run>
          <prepare_for_estimate type="dictionary">
            <name name="name" type="string">prepare_for_estimate</name>
            <output name="output" type="string">(collcm_specification, collcm_index, colagents)</output>
            <argument name="agent_set" type="string" model_dependency_type="dataset">person</argument>
            <argument name="agents_for_estimation_storage" type="string" convert_blank_to_none="True">base_cache_storage</argument>
            <argument name="agents_for_estimation_table" type="string" convert_blank_to_none="True" parser_action="quote_string" model_dependency_type="table">persons_for_estimation</argument>
            <argument name="agent_filter" type="string" convert_blank_to_none="True" parser_action="quote_string" model_dependency_type="variable">is_student_in_college = ((person.stype == 4) + (person.stype == 5)) * (psrc_parcel.person.age_category==5)</argument>
          </prepare_for_estimate>
          <estimate type="dictionary">
            <output name="output" type="string">(collcm_coefficients, dummy)</output>
            <argument name="agent_set" type="string">colagents</argument>
            <argument name="agents_index" type="string">collcm_index</argument>
            <argument name="procedure" type="string" parser_action="quote_string">opus_core.bhhh_mnl_estimation</argument>
            <argument name="debuglevel" type="string">debuglevel</argument>
            <argument name="specification" type="string">collcm_specification</argument>
          </estimate>
       </structure>
       <specification type="dictionary" inherit_parent_values="False">
          <submodel name="submodel" submodel_id="-2" type="submodel" hidden="Children">
            <variable_list type="variable_list">
              <variable_spec name="person_x_school.ln_travel_distance_to_school" fixed_value="-5"/>
              <variable_spec name="school.ln_staff" fixed_value="1"/>
            </variable_list>
           </submodel>
       </specification>
    </model>
    <model name="convert_to_new_zones_model" type="model">
        <dependencies type="list">[]</dependencies>
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module type="string">opus_core.simple_model</class_module>
            <class_name type="string">SimpleModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">SimpleModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">parcel</argument>
            <argument name="expression" parser_action="quote_string" type="string" model_dependency_type="variable">parcel.disaggregate(parcels_new_zone.zone_id)</argument>
            <argument name="outcome_attribute" parser_action="quote_string" type="string">new_zone_id</argument>
            <argument name="dataset_pool" type="string">dataset_pool</argument>
          </run>
        </structure>
        <specification type="dictionary"/>
      </model>
      <model name="modify_workers_jobs_after_moving_jobs" type="model">
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module>opus_core.join_attribute_modification_model</class_module>
            <class_name>JoinAttributeModificationModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">JoinAttributeModificationModel</name>
          </init>
          <run type="dictionary">
            <argument model_dependency_type="dataset" name="dataset" type="string">person</argument>
            <argument model_dependency_type="dataset" name="secondary_dataset" type="string">job</argument>
            <argument name="attribute_to_be_modified" parser_action="quote_string" type="string">job_id</argument>
            <argument name="value" type="integer">-1</argument>
            <argument model_dependency_type="variable" name="filter" parser_action="quote_string" type="string">job.building_id != urbansim.job.building_id_lag2</argument>
          </run>
        </structure>
      </model>
      <model name="modify_workers_jobs_after_moving_households_if_lower_accessibility" type="model">
        <structure type="dictionary">
          <import name="import" type="dictionary">
            <class_module>opus_core.join_attribute_modification_model</class_module>
            <class_name>JoinAttributeModificationModel</class_name>
          </import>
          <init type="dictionary">
            <name name="name" type="string">JoinAttributeModificationModel</name>
          </init>
          <run type="dictionary">
            <argument name="dataset" type="string" model_dependency_type="dataset">person</argument>
            <argument name="secondary_dataset" type="string" model_dependency_type="dataset">household</argument>
            <argument name="attribute_to_be_modified" parser_action="quote_string" type="string">job_id</argument>
            <argument name="value" type="integer">-1</argument>
            <argument name="filter" type="string" parser_action="quote_string" model_dependency_type="variable">(household.building_id != urbansim.household.building_id_lag2) * (psrc_parcel.household.max_network_distance_from_home_to_work > psrc_parcel.household.max_network_distance_from_home_to_work_lag2)</argument>
          </run>
        </structure>
      </model>
</models>
<estimation_config config_name="estimation_config" name="Estimation Configuration" type="configuration">
<!-- <cache_directory parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/base_year_data_school_estimation</cache_directory>  -->
<cache_directory parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/base_year_estimation_4K</cache_directory>
<save_estimation_results type="boolean">False</save_estimation_results>
<base_year type="integer" field_identifier="Base Year">2006</base_year>
<years type="tuple">
        <firstyear type="integer" field_identifier="Base Year">2006</firstyear>
        <lastyear type="integer" field_identifier="Base Year">2006</lastyear>
</years>
      <datasets_to_preload parser_action="list_to_dictionary" type="selectable_list">
      <selectable copyable="True" type="selectable" name="school">True</selectable>
        <selectable copyable="True" type="selectable" name="person">True</selectable>
      </datasets_to_preload>
</estimation_config>
</model_manager>
  <scenario_manager>  
      <scenario executable="True" name="psrc_with_school_models" type="scenario">
    <parent type="scenario_name">PSRC_baseline</parent>
      <base_year type="integer">2014</base_year>
      <years_to_run config_name="years" type="tuple">
        <firstyear type="integer">2041</firstyear>
        <lastyear type="integer">2041</lastyear>
      </years_to_run>
      <seed type="integer" convert_blank_to_none="True">1</seed>
      <flush_variables type="boolean">True</flush_variables>
      <models_to_run config_name="models" type="selectable_list"> 
      <selectable name="modify_workers_jobs_after_moving_households_if_lower_accessibility" type="model_choice">False</selectable>
      <selectable name="modify_workers_jobs_after_moving_jobs" type="model_choice">False</selectable>
      <selectable name="work_at_home_choice_model" type="model_choice">False</selectable>
      <selectable name="workplace_choice_model_for_resident" type="model_choice">False</selectable>
      <selectable name="home_school_for_oldest_child_model" type="model_choice">True</selectable>
      <selectable name="home_school_for_younger_children_model" type="model_choice">True</selectable>
      <selectable name="public_private_school_for_oldest_child_model" type="model_choice">True</selectable>
      <selectable name="postprocess_public_private_school_for_oldest_child_model" type="model_choice">True</selectable>
      <selectable name="public_private_school_for_younger_children_model" type="model_choice">True</selectable>
      <selectable name="school_choice_model_public" type="model_choice">False</selectable>
      <selectable name="school_choice_model_public_no_schools_in_district" type="model_choice">False</selectable>
      <selectable name="initiate_school_id_in_persons" type="model_choice">True</selectable>
      <selectable name="school_choice_model_public_assign_2" type="model_choice">False</selectable>
      <selectable name="school_choice_model_public_assign_3" type="model_choice">False</selectable>
      <selectable name="school_choice_model_public_assign_4" type="model_choice">False</selectable>
      <selectable name="school_choice_model_public_distance_2" type="model_choice">True</selectable>
      <selectable name="school_choice_model_public_distance_3" type="model_choice">True</selectable>
      <selectable name="school_choice_model_public_distance_4" type="model_choice">True</selectable>
      <selectable name="school_choice_model_private_for_oldest_child" type="model_choice">True</selectable>
      <selectable name="school_choice_model_private_for_younger_siblings" type="model_choice">True</selectable>
      <selectable name="school_choice_model_preschool" type="model_choice">True</selectable>
      <selectable name="college_location_model" type="model_choice">True</selectable>
      <selectable name="convert_to_new_zones_model" type="model_choice">False</selectable>
      </models_to_run>
      <creating_baseyear_cache_configuration type="class">
        <class_name hidden="True" type="string">CreatingBaseyearCacheConfiguration</class_name>
        <class_module hidden="True" type="string">urbansim.configurations.creating_baseyear_cache_configuration</class_module>
        <argument config_name="cache_directory_root" name="scenario_runs_directory" parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/runs</argument>
        <argument name="baseyear_cache" type="class">
          <class_name hidden="True" type="string">BaseyearCacheConfiguration</class_name>
          <class_module hidden="True" type="string">opus_core.configurations.baseyear_cache_configuration</class_module>
          <!-- <argument name="existing_cache_to_copy" parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/base_year_data_school</argument> -->
          <!--<argument name="existing_cache_to_copy" parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/LUVrefinements/run_133ref</argument> -->
          <!--<argument name="existing_cache_to_copy" parser_action="prefix_with_opus_data_path" type="directory">psrc_parcel/base_year_data_school_estimation</argument>-->
	  <argument name="existing_cache_to_copy" type="directory">/Volumes/d$/opusgit/urbansim_data/data/psrc_parcel/runs/run_64R.schools_base</argument>
        </argument>
        <argument hidden="True" name="unroll_gridcells" type="boolean">False</argument>
        <argument name="advanced" type="category">
          <baseyear_database_configuration config_name="scenario_database_configuration" type="class">
            <class_name hidden="True" type="string">ScenarioDatabaseConfiguration</class_name>
            <class_module hidden="True" type="string">opus_core.database_management.configurations.scenario_database_configuration</class_module>
            <argument name="database_name" type="string">psrc_2000_parcel_baseyear_data</argument>
          </baseyear_database_configuration>
          <cache_from_database type="boolean">False</cache_from_database>
          <cache_scenario_database type="string">urbansim.model_coordinators.cache_scenario_database</cache_scenario_database>
              </argument>
      </creating_baseyear_cache_configuration>
      </scenario>
   </scenario_manager>
</opus_project>
